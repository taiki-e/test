env:
  RUSTFLAGS: -D warnings

linux_task:
  matrix:
    - name: x86_64-unknown-linux-gnu
      container:
        image: rust:latest
    - name: aarch64-unknown-linux-gnu
      arm_container:
        image: rust:latest
  setup_script:
    - rustup update nightly && rustup default nightly
    - grep -E -m 1 '^(flags|Features)' /proc/cpuinfo
  test_script:
    - cargo test --all --all-features

freebsd_task:
  name: x86_64-unknown-freebsd
  freebsd_instance:
    # https://cirrus-ci.org/guide/FreeBSD/#list-of-available-image-families
    image: freebsd-12-2-release-amd64
  setup_script:
    - |
      pkg install -y curl
      curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs \
        | sh -s -- -y --profile minimal --default-toolchain nightly --component rustfmt,clippy,rust-src
    - grep -E 'Features.*=' /var/run/dmesg.boot
  test_script:
    - . $HOME/.cargo/env
    - cargo test --all --all-features
